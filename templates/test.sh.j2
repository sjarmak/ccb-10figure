#!/bin/bash
# Harbor test script template for 10Figure patch validation
set -e
set -x  # Enable verbose mode to see what's executing

PATCH_FILE="/logs/agent/patch.diff"
TASK_YAML="/task/task.yaml"
CORPUS_ROOT="{{ corpus_root }}"
VALIDATOR="/10figure/scripts/validate_patch.py"
REWARD_FILE="/logs/verifier/reward.txt"
VALIDATION_RESULT="/logs/verifier/validation_result.json"

echo "=== 10Figure Patch Validation ===" >&2
echo "Patch: $PATCH_FILE" >&2
echo "Task: $TASK_YAML" >&2
echo "Corpus: $CORPUS_ROOT" >&2
echo "" >&2

# Check if patch exists
if [ ! -f "$PATCH_FILE" ]; then
    echo "ERROR: Patch file not found: $PATCH_FILE" >&2
    echo "0.0" > "$REWARD_FILE"
    exit 1
fi

# Check if patch is empty
if [ ! -s "$PATCH_FILE" ]; then
    echo "WARNING: Patch file is empty - agent made no changes" >&2
    echo "0.0" > "$REWARD_FILE"
    exit 0
fi

echo "Patch size: $(wc -l < "$PATCH_FILE") lines" >&2
echo "" >&2

# Verify tasks directory exists (should be in base image)
if [ ! -d "$CORPUS_ROOT/tasks" ]; then
    echo "ERROR: Tasks directory not found at $CORPUS_ROOT/tasks" >&2
    echo "0.0" > "$REWARD_FILE"
    exit 1
fi

TASK_COUNT=$(ls "$CORPUS_ROOT/tasks"/*.yaml 2>/dev/null | wc -l)
echo "Found $TASK_COUNT task files in $CORPUS_ROOT/tasks" >&2

# Run validator from corpus root with correct arguments
echo "Changing to $CORPUS_ROOT..." >&2
cd "$CORPUS_ROOT" || { echo "Failed to cd to $CORPUS_ROOT" >&2; exit 1; }

echo "Running validator..." >&2
if python3 "$VALIDATOR" "$PATCH_FILE" --output "$VALIDATION_RESULT" 2>&1; then
    echo "Validator completed successfully" >&2
    
    # Extract reward from validation result
    echo "Extracting reward..." >&2
    REWARD=$(python3 -c "import json; print(json.load(open('$VALIDATION_RESULT'))['overall_score'])")
    echo "$REWARD" > "$REWARD_FILE"
    echo "" >&2
    echo "✅ Validation successful - Reward: $REWARD" >&2
    exit 0
else
    echo "❌ Validation failed" >&2
    echo "0.0" > "$REWARD_FILE"
    exit 1
fi
